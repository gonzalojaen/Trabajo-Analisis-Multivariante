---
title: "ANÁLISIS MULTIVARIANTE"
author: "Grupo 2.4"
date: "2025-03-09"
output: html_document
---

# DESCRIPTIVA BIVARIANTE: Datos categóricos preprocesados {.tabset}

## Lectura de los datos y preparación

```{r,echo=F, warning=F, message=F}
library(readr)
library(visdat)
library(inspectdf)
library(skimr)
library(tidyverse)
library(plotly)
library(tinyplot)
library(knitr)
```


```{r, warning=F, message=F}
datos<-read_csv("StudentPerformanceFactors_1.csv")
tipos <- sapply(datos, class)
varCat <- names(tipos)[tipos %in% c("factor", "character")]
varCat<-varCat[-14]
```


## Tablas de contingencia

En el siguiente código se genera un HTML externo dónde se pueden encontrar todas las tablas de contingencia entre las variables categóricas (78 en total)

```{r}
datos_categoricos <- datos[sapply(datos, is.factor) | sapply(datos, is.character)]
datos_categoricos <- datos_categoricos[,-14]  # Eliminar columna 14 si es necesario

combinaciones <- combn(names(datos_categoricos), 2, simplify = FALSE)

sink("tablas_contingencia.html")
cat("<html><body><h1>TABLAS DE CONTINGENCIA</h1>")  # Título 

lapply(combinaciones, function(par) {
  tabla <- table(datos_categoricos[[par[1]]], datos_categoricos[[par[2]]])
    tabla_con_margenes <- addmargins(tabla, margin = c(1, 2), FUN = list(Total = sum))

  cat("<h2>", paste(par[1], "vs", par[2]), "</h2>")  # Título
  cat("<pre>")  # Formato para que la tabla se vea bien
  print(tabla_con_margenes)
  cat("</pre>")
})

cat("</body></html>")  # Cerrar el HTML

sink()

```

## Test de Independencia

Usaremos el Test de la Chi-cuadrado, que realiza la siguiente prueba de hipótesis:

$$\left\{\begin{array}{l}\text{H}_0: \text{Las dos variables categóricas son independientes}\\ \text{H}_1:\text{Las dos variables categóricas no son independientes}\end{array}\right.$$

```{r}
# Definir las 3 variables de interés
vars_interes <- c("Teacher_Quality", "Parental_Education_Level", "Distance_from_Home")

combinaciones <- combn(names(datos_categoricos), 2, simplify = FALSE)

combinaciones_filtradas <- Filter(function(par) any(par %in% vars_interes), combinaciones)

resultados_chi_df <- do.call(rbind, lapply(combinaciones_filtradas, function(par) {
  tabla <- table(datos_categoricos[[par[1]]], datos_categoricos[[par[2]]])
  
  if (all(tabla > 0)) {
    test_chi <- chisq.test(tabla)
    
    data.frame(
      Variable1 = par[1],
      Variable2 = par[2],
      X_squared = test_chi$statistic,
      df = test_chi$parameter,
      p_value = test_chi$p.value
    )
  } else {
    data.frame(
      Variable1 = par[1],
      Variable2 = par[2],
      X_squared = NA,
      df = NA,
      p_value = NA
    )
  }
}))

rownames(resultados_chi_df) <- NULL

kable(resultados_chi_df, caption = "RESULTADOS TEST DE INDEPENDENCIA")

```

En la tabla podemos observar las dos variables comparadas, el estadístico chi-cuadrado, los grados de libertad y el p-valor del test para las variables de interés en este caso.

A continuación estudiaremos qué p-valores son inferiores a 0.05 (nivel de significación fijado) y así podremos ver qué variables no son independientes entre si, y por lo tanto tienen asociación.

```{r}
index<-which(resultados_chi_df$p_value<0.05, arr.ind=T)
a<-resultados_chi_df[index, c(1,2,5)]
kable(a)
```

## Análisis gráfico bivariante

En las siguientes líneas de código se realizarán gráficos bivariantes (Barplots múltiples principalmente) a modo de comparación entre las variables categóricas.

```{r}
library(ggplot2)
library(tidyr)

plots <- lapply(combinaciones_filtradas, function(par) {
  ggplot(datos, aes(x = !!sym(par[1]), fill = !!sym(par[2]))) +
    geom_bar(position = "dodge") +
    labs(title = paste("Distribución de", par[1], "vs", par[2]),
         x = par[1], y = "Frecuencia", fill = par[2]) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
})

plots
```